<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Boutique - Love Market</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="logo">ğŸ’• Love Market</div>
      <% if (user) { %>
      <nav class="nav">
        <a href="/dashboard" title="Dashboard" class="<%= currentPath === '/dashboard' ? 'nav-active' : '' %>">ğŸ <span class="nav-text"> Accueil</span></a>
        <a href="/shop" title="Boutique" class="<%= currentPath === '/shop' ? 'nav-active' : '' %>">ğŸ›ï¸<span class="nav-text"> Boutique</span></a>
        <a href="/my-services" title="Mes services" class="<%= currentPath === '/my-services' ? 'nav-active' : '' %>">ğŸ¤<span class="nav-text"> Mes services</span></a>
        <a href="/negotiations" title="NÃ©gociations" class="nav-link-with-badge <%= currentPath === '/negotiations' ? 'nav-active' : '' %>">
          ğŸ’¬<span class="nav-text"> NÃ©gociations</span>
          <% if (notificationCount > 0) { %>
          <span class="notification-badge"><%= notificationCount %></span>
          <% } %>
        </a>
        <% if (user.role === 'admin') { %>
        <a href="/admin" class="admin-link <%= currentPath === '/admin' ? 'nav-active' : '' %>" title="Admin">âš™ï¸<span class="nav-text"> Admin</span></a>
        <% } %>
      </nav>
      <div class="user-info">
        <span class="credits"><%= user.credits %> â¤ï¸</span>
        <span class="user-name"><%= user.displayName %></span>
        <a href="/logout" class="logout">DÃ©connexion</a>
      </div>
      <% } %>
    </header>

    <main class="page">
      <section class="section">
        <div class="shop-header">
          <h1 class="section-title"> Boutique de <span style="color: #e91e63;"><%= partner ? partner.displayName : 'partenaire' %></span> ğŸ’</h1>
          <div class="user-credits">
            <% if (partner) { %>
            <p>
              Tes crÃ©dits : <strong><%= user.credits %> â¤ï¸</strong> â€” CrÃ©dits de ton/ta partenaire
              <strong><%= partner.credits %> â¤ï¸</strong>
            </p>
            <% } %>
          </div>
        </div>
        
        <% if (!services.length) { %>
        <div class="empty-shop">
          <p>Ton partenaire nâ€™a encore rien mis en vente. Tu peux lui suggÃ©rer une idÃ©e douce.</p>
        </div>
        <% } else { %>
        <div class="product-list">
          <% services.forEach(function(service) { %>
          <div class="product-item">
            <div class="product-main">
              <div class="product-icon">
                <span class="service-icon" style="font-size: 4rem;"><%= service.icon || 'ğŸ’—' %></span>
              </div>
              <div class="product-details">
                <h3 class="product-title"><%= service.title %></h3>
                <p class="product-category"><%= service.category %></p>
                <% if (service.description) { %>
                <p class="product-description"><%= service.description %></p>
                <% } %>
              </div>
            </div>
            <div class="product-footer">
              <div class="product-price">
                <span class="price-amount"><%= service.price %> â¤ï¸</span>
              </div>
              <div class="product-actions">
                <form 
                  method="post" 
                  action="/services/<%= service.id %>/buy" 
                  class="inline-form"
                  onsubmit="return confirmPurchase(<%= service.price %>, <%= user.credits %>)"
                >
                  <button type="submit" class="btn-primary btn-buy">Acheter</button>
                </form>
                <form method="post" action="/services/<%= service.id %>/offer" class="offer-form">
                  <input
                    type="number"
                    name="offeredPrice"
                    min="0"
                    step="1"
                    placeholder="Ta proposition"
                    required
                  />
                  <input
                    type="text"
                    name="comment"
                    placeholder="Ajoute un petit mot"
                  />
                  <button type="submit" class="btn-secondary btn-negotiate">NÃ©gocier</button>
                </form>
              </div>
            </div>
          </div>
          <% }) %>
        </div>
        <% } %>
      </section>
    </main>

    <script>
      function confirmPurchase(price, currentCredits) {
        if (currentCredits < price) {
          alert(
            "CrÃ©dits insuffisants !\n\n" +
            "Prix : " + price + " â¤ï¸\n" +
            "Votre solde : " + currentCredits + " â¤ï¸\n" +
            "Il vous manque " + (price - currentCredits) + " â¤ï¸"
          );
          return false;
        }
        
        const newBalance = currentCredits - price;
        const message = 
          "ÃŠtes-vous sÃ»r de vouloir acheter ce service ?\n\n" +
          "Solde actuel : " + currentCredits + " â¤ï¸\n" +
          "Prix : " + price + " â¤ï¸\n" +
          "Nouveau solde : " + newBalance + " â¤ï¸\n\n" +
          "Les crÃ©dits seront dÃ©bitÃ©s immÃ©diatement.\n" +
          "Votre partenaire devra accepter la demande.\n" +
          "Si refusÃ©, vous serez remboursÃ©.";
        
        return confirm(message);
      }
    </script>
  </body>
</html>
